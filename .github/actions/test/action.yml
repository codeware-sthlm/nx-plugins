name: Test

description: Build, lint, test and format code

inputs:
  codecov-token:
    description: Provide codecov token to upload test coverage
    required: false
    default: ''

runs:
  using: composite

  steps:
    - name: Derive SHA's for Nx affected `base` and `head` arguments
      id: sha
      uses: nrwl/nx-set-shas@v4
      with:
        main-branch-name: master

    - name: Check all projects for un-formatted files
      shell: bash
      run: yarn nx format:check --all

    - name: Lint affected projects
      shell: bash
      run: yarn nx affected -t lint --base ${{ steps.sha.outputs.base }} --head ${{ steps.sha.outputs.head }}

    - name: Build affected projects
      shell: bash
      run: yarn nx affected -t build --base ${{ steps.sha.outputs.base }} --head ${{ steps.sha.outputs.head }}

    - name: Unit test all projects
      shell: bash
      run: yarn nx run-many -t test --codeCoverage --verbose

    - name: E2e affected projects
      shell: bash
      run: yarn nx affected -t e2e --base ${{ steps.sha.outputs.base }} --head ${{ steps.sha.outputs.head }}

    - name: Code coverage upload
      if: ${{ inputs.codecov-token }}
      uses: codecov/codecov-action@v3
      with:
        token: ${{ inputs.codecov-token }}
